apiVersion: apps/v1
kind: Deployment
metadata:
  name: training-ai
  labels:
    app: training-ai
spec:
  replicas: 1
  selector:
    matchLabels:
      app: training-ai
  template:
    metadata:
      name: training-ai
      labels:
        app: training-ai
    spec:
      containers:
        - name: training-ai-server
          image: training-ai-server-image
          imagePullPolicy: Always
          ports:
            - containerPort: 7932
              name: http
          readinessProbe:
            httpGet:
              path: /api/health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /api/health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 20
          resources:
            requests:
              cpu: 5m
              memory: 10Mi
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            runAsNonRoot: true
            readOnlyRootFilesystem: false # Needs access to write files
            allowPrivilegeEscalation: false
            privileged: false
            capabilities:
              drop:
                - ALL
          env:
            - name: MODEL
              value: openai:gpt-5.2
            - name: MCP_SERVER_URL
              value: http://intervals-mcp-service:8000/mcp
            - name: SIGNAL_API_URL
              value: http://signal-api:8080
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: training-ai-secrets
                  key: OPENAI_API_KEY
            - name: SIGNAL_NUMBER
              valueFrom:
                secretKeyRef:
                  name: training-ai-secrets
                  key: SIGNAL_NUMBER
            - name: LOGFIRE_TOKEN
              valueFrom:
                secretKeyRef:
                  name: training-ai-secrets
                  key: LOGFIRE_TOKEN
            - name: LOGFIRE_ENVIRONMENT
              value: production
            - name: BASE_INSTRUCTIONS
              valueFrom:
                secretKeyRef:
                  name: training-ai-base-instructions
                  key: BASE_INSTRUCTIONS
            - name: SUMMARY_USER_MESSAGE
              value: |
                Create a concise summary of my activities and fitness development
                over the provided time ranges. Respond in plain text. Do not 
                summarize by numbers but by words: how tough an activity was,
                was the activity long or short, what aspects it developed. If my 
                estimated FTP changes, that can be told in numbers.
                For fitness tell me if I'm increasing or decreasing my fitness
                and how my form has been. Also give a suggestion for the next day's workouts.
      restartPolicy: Always
